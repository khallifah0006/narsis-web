import StoryModel from"./StoryModel.js";import StoryPresenter from"./StoryPresenter.js";const DEFAULT_MAP_CENTER=[-6.2088,106.8456],AddStory={async renderAddStory(){let e,t,a;document.getElementById("app").innerHTML='\n      <div class="form-container">\n        <h2 class="form-title">Share Your Story</h2>\n        <form id="add-story-form">\n          <div class="camera-container">\n            <label>Take a Photo</label>\n            <div class="camera-preview" id="camera-preview">\n              <i class="fas fa-camera fa-3x"></i>\n            </div>\n            <div class="camera-buttons">\n              <button type="button" id="start-camera" class="btn btn-secondary">\n                <i class="fas fa-camera"></i> Start Camera\n              </button>\n              <button type="button" id="capture-photo" class="btn btn-primary" disabled>\n                <i class="fas fa-camera-retro"></i> Capture\n              </button>\n              <button type="button" id="retry-photo" class="btn btn-danger" disabled>\n                <i class="fas fa-redo"></i> Retry\n              </button>\n            </div>\n          </div>\n          \n          <div class="form-group">\n            <label for="story-description">Description</label>\n            <textarea id="story-description" rows="4" required></textarea>\n          </div>\n          \n          <div>\n            <label>Select Location (Click on the map)</label>\n            <div id="add-map" class="add-map"></div>\n            <div class="form-group">\n              <label for="story-location">Selected Location</label>\n              <input type="text" id="story-location" readonly>\n            </div>\n          </div>\n          \n          <button type="submit" class="btn btn-primary">\n            <i class="fas fa-paper-plane"></i> Share Story\n          </button>\n        </form>\n      </div>\n    ',setTimeout((()=>{null!==L.DomUtil.get("add-map")&&void 0!==L.DomUtil.get("add-map")._leaflet_id&&(L.DomUtil.get("add-map")._leaflet_id=null),a=L.map("add-map").setView(DEFAULT_MAP_CENTER,13),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(a),a.on("click",(e=>{t&&a.removeLayer(t),t=L.marker(e.latlng).addTo(a),document.getElementById("story-location").value=`Lat: ${e.latlng.lat.toFixed(6)}, Lng: ${e.latlng.lng.toFixed(6)}`}))}),100);let n=null;const o=document.getElementById("start-camera"),r=document.getElementById("capture-photo"),i=document.getElementById("retry-photo"),d=document.getElementById("camera-preview");o.addEventListener("click",(async()=>{try{e=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"},audio:!1});const t=document.createElement("video");t.srcObject=e,t.autoplay=!0,t.id="camera-stream",d.innerHTML="",d.appendChild(t),o.disabled=!0,r.disabled=!1}catch(e){StoryPresenter.showNotification("Failed to access camera: "+e.message,!0)}})),r.addEventListener("click",(()=>{const t=document.getElementById("camera-stream"),a=document.createElement("canvas");a.width=t.videoWidth,a.height=t.videoHeight,a.getContext("2d").drawImage(t,0,0,a.width,a.height);const o=document.createElement("img");o.src=a.toDataURL("image/jpeg"),o.id="captured-image",a.toBlob((e=>{n=e}),"image/jpeg"),d.innerHTML="",d.appendChild(o),r.disabled=!0,i.disabled=!1,e&&e.getTracks().forEach((e=>e.stop()))})),i.addEventListener("click",(()=>{n=null,d.innerHTML='<i class="fas fa-camera fa-3x"></i>',o.disabled=!1,r.disabled=!0,i.disabled=!0})),document.getElementById("add-story-form").addEventListener("submit",(async e=>{if(e.preventDefault(),!n)return void StoryPresenter.showNotification("Please take a photo first",!0);const s=document.getElementById("story-description").value;let l=null,c=null;t&&(l=t.getLatLng().lat,c=t.getLatLng().lng);try{await StoryModel.addStory(s,n,l,c),StoryPresenter.showNotification("Story shared successfully!"),document.getElementById("add-story-form").reset(),d.innerHTML='<i class="fas fa-camera fa-3x"></i>',n=null,t&&(a.removeLayer(t),t=null),o.disabled=!1,r.disabled=!0,i.disabled=!0,setTimeout((()=>{window.location.hash="#/"}),1500)}catch(e){StoryPresenter.showNotification(e.message,!0)}}))}};export default AddStory;