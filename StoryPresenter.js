import StoryModel from"./StoryModel.js";import{StoryDB}from"./db.js";import UI from"./UI.js";import Home from"./Home.js";import AddStory from"./AddStory.js";import Profile from"./Profile.js";let stream;const StoryPresenter={init(){this.initRouter(),this.initEventListeners(),this.updateAuthUI()},initRouter(){window.addEventListener("hashchange",this.handleRouteChange.bind(this)),this.handleRouteChange()},handleRouteChange(){const t=window.location.hash||"#/",e={"#/":Home.renderHome.bind(Home),"#/add-story":AddStory.renderAddStory.bind(AddStory),"#/profile":Profile.renderProfile.bind(Profile)};document.startViewTransition?document.startViewTransition((()=>{(e[t]||e["#/"])(),document.querySelectorAll(".nav-item").forEach((e=>{e.getAttribute("href")===t?e.classList.add("active"):e.classList.remove("active")}))})):((e[t]||e["#/"])(),document.querySelectorAll(".nav-item").forEach((e=>{e.getAttribute("href")===t?e.classList.add("active"):e.classList.remove("active")})))},async fetchAndCacheStories(){try{const t=await StoryModel.getAllStories(1,20,1);return await StoryDB.clearStories(),t.forEach((t=>StoryDB.saveStory(t))),t}catch(t){return console.log("Offline mode: Loading stories from IndexedDB"),await StoryDB.getStories()}},async showStoryDetail(t){const e=document.getElementById("story-detail-modal"),o=document.getElementById("story-detail-container");o.innerHTML='\n      <div class="loader">\n        <div class="spinner"></div>\n      </div>\n    ',e.style.display="block";try{const e=await StoryModel.getStoryDetail(t);o.innerHTML=`\n        <div class="story-detail">\n          <img src="${e.photoUrl}" alt="Photo for story by ${e.name}" class="story-detail-image">\n          <div class="story-detail-info">\n            <div>\n              <h3>${e.name}'s Story</h3>\n              <p><i class="fas fa-calendar"></i> ${new Date(e.createdAt).toLocaleDateString()}</p>\n            </div>\n          </div>\n          <p>${e.description}</p>\n          ${e.lat&&e.lon?'<div id="detail-map" class="story-map"></div>':""}\n        </div>\n      `,e.lat&&e.lon&&setTimeout((()=>{const t=L.map("detail-map").setView([e.lat,e.lon],13),o=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}),n={Street:o,Satellite:L.tileLayer("https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}",{maxZoom:20,subdomains:["mt0","mt1","mt2","mt3"],attribution:"&copy; Google Maps"}),Topographic:L.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://opentopomap.org">OpenTopoMap</a> contributors'})};o.addTo(t),L.control.layers(n).addTo(t),L.marker([e.lat,e.lon]).addTo(t).bindPopup(`<strong>${e.name}'s Story</strong><br>${e.description.substring(0,100)}...`).openPopup()}),100)}catch(t){o.innerHTML=`<p class="error">Error loading story details: ${t.message}</p>`}},initEventListeners(){document.getElementById("login-button").addEventListener("click",(()=>{document.getElementById("login-modal").style.display="block"})),document.getElementById("register-button").addEventListener("click",(()=>{document.getElementById("register-modal").style.display="block"})),document.getElementById("logout-button").addEventListener("click",(()=>{StoryModel.logout(),this.updateAuthUI(),this.showNotification("Logged out successfully"),window.location.hash="#/"})),document.getElementById("login-form").addEventListener("submit",(async t=>{t.preventDefault();const e=document.getElementById("login-email").value,o=document.getElementById("login-password").value;try{await StoryModel.login(e,o),document.getElementById("login-modal").style.display="none",this.updateAuthUI(),this.showNotification("Logged in successfully"),window.location.hash="#/"}catch(t){this.showNotification(t.message,!0)}})),document.getElementById("register-form").addEventListener("submit",(async t=>{t.preventDefault();const e=document.getElementById("register-name").value,o=document.getElementById("register-email").value,n=document.getElementById("register-password").value;try{await StoryModel.register(e,o,n),document.getElementById("register-modal").style.display="none",this.showNotification("Registration successful. Please login.")}catch(t){this.showNotification(t.message,!0)}})),document.querySelectorAll(".close").forEach((t=>{t.addEventListener("click",(()=>{document.querySelectorAll(".modal").forEach((t=>{t.style.display="none"})),stream&&(stream.getTracks().forEach((t=>t.stop())),stream=null)}))})),window.addEventListener("click",(t=>{document.querySelectorAll(".modal").forEach((e=>{t.target===e&&(e.style.display="none",stream&&(stream.getTracks().forEach((t=>t.stop())),stream=null))}))}))},updateAuthUI(){UI.updateAuthUI()},showNotification(t,e=!1){const o=document.getElementById("notification"),n=document.getElementById("notification-message");o.classList.remove("hidden","error"),e&&o.classList.add("error"),n.textContent=t,setTimeout((()=>{o.classList.add("hidden")}),3e3)},urlBase64ToUint8Array(t){const e=(t+"=".repeat((4-t.length%4)%4)).replace(/-/g,"+").replace(/_/g,"/"),o=window.atob(e),n=new Uint8Array(o.length);for(let t=0;t<o.length;++t)n[t]=o.charCodeAt(t);return n}};export default StoryPresenter;